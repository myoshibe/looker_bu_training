{% extends "base.html" %}

{% block content %}
<div class="text-center">
    <h2>Mappa</h2>

    {% if current_user.is_anonymous %}

    <p>Please login to use the app</p>
    <a href="{{ url_for('login') }}">login</a>

    {% else %}

    {% endif %}

    <p>This will be a page where you can create a custom image with your activity data</p>

    <div class="container-fluid">
      <form method="POST" action="/mappa" enctype="multipart/form-data">
            <div class="form-group">
              <label>Image</label>
              <input type="file" class="btn btn-primary" name="file"><button type="submit" class="btn btn-primary">submit</button>
            </div>
      </form>
    </div>

</div>
<div id="buttons">
  <button id="save">
    Save as image
  </button>
  <button id="data">
    Add Data
  </button>
</div>


<div class="w-100 p-3" role="presentation" style="position: relative; user-select: none; width: 1000; height: 1000;">
  <canvas class='img-responsive' width="1000" height="1000" style="padding: 0px; margin: 0px; border: 0px; background: 'black'; position: absolute; top: 0px; left: 0px; width: 1000; height: 1000; display: block;">
  </canvas>


  <body>
    <div id="container"></div>
    <script>
      var width = window.innerWidth;
      var height = window.innerHeight;

      function update(activeAnchor) {
        var group = activeAnchor.getParent();

        var topLeft = group.get('.topLeft')[0];
        var topRight = group.get('.topRight')[0];
        var bottomRight = group.get('.bottomRight')[0];
        var bottomLeft = group.get('.bottomLeft')[0];
        var image = group.get('Image')[0];

        var anchorX = activeAnchor.getX();
        var anchorY = activeAnchor.getY();

        // update anchor positions
        switch (activeAnchor.getName()) {
          case 'topLeft':
            topRight.y(anchorY);
            bottomLeft.x(anchorX);
            break;
          case 'topRight':
            topLeft.y(anchorY);
            bottomRight.x(anchorX);
            break;
          case 'bottomRight':
            bottomLeft.y(anchorY);
            topRight.x(anchorX);
            break;
          case 'bottomLeft':
            bottomRight.y(anchorY);
            topLeft.x(anchorX);
            break;
        }

        image.position(topLeft.position());

        var width = topRight.getX() - topLeft.getX();
        var height = bottomLeft.getY() - topLeft.getY();
        if (width && height) {
          image.width(width);
          image.height(height);
        }
      }

      function addAnchor(group, x, y, name) {
        var stage = group.getStage();
        var layer = group.getLayer();

        var anchor = new Konva.Circle({
          x: x,
          y: y,
          stroke: '#666',
          fill: '#ddd',
          strokeWidth: 2,
          radius: 8,
          name: name,
          draggable: true,
          dragOnTop: false
        });

        anchor.on('dragmove', function() {
          update(this);
          layer.draw();
        });
        anchor.on('mousedown touchstart', function() {
          group.draggable(false);
          this.moveToTop();
        });
        anchor.on('dragend', function() {
          group.draggable(true);
          layer.draw();
        });
        // add hover styling
        anchor.on('mouseover', function() {
          var layer = this.getLayer();
          document.body.style.cursor = 'pointer';
          this.strokeWidth(4);
          layer.draw();
        });
        anchor.on('mouseout', function() {
          var layer = this.getLayer();
          document.body.style.cursor = 'default';
          this.strokeWidth(2);
          layer.draw();
        });

        group.add(anchor);
      }

      var stage = new Konva.Stage({
        container: 'container',
        width: width,
        height: height
      });

      var layer = new Konva.Layer();
      stage.add(layer);

      // darth vader - route
      var darthVaderImg = new Konva.Image({
        width: 400,
        height: 400
      });

      // yoda - elevation
      var yodaImg = new Konva.Image({
        width: 1000,
        height: 200
      });

      // background
      var backgroundImg = new Konva.Image({
        width: 1000,
        height: 1000
      });

      var backgroundGroup = new Konva.Group({
        x: 0,
        y: 0
      });
      layer.add(backgroundGroup);
      backgroundGroup.add(backgroundImg);

      var darthVaderGroup = new Konva.Group({
        x: 50,
        y: 550,
        draggable: true
      });
      layer.add(darthVaderGroup);
      darthVaderGroup.add(darthVaderImg);
      addAnchor(darthVaderGroup, 0, 0, 'topLeft');
      addAnchor(darthVaderGroup, 450, 0, 'topRight');
      addAnchor(darthVaderGroup, 450, 450, 'bottomRight');
      addAnchor(darthVaderGroup, 0, 450, 'bottomLeft');

      var yodaGroup = new Konva.Group({
        x: 0,
        y: 800,
        draggable: true
      });
      layer.add(yodaGroup);
      yodaGroup.add(yodaImg);
      addAnchor(yodaGroup, 0, 0, 'topLeft');
      addAnchor(yodaGroup, 1000, 0, 'topRight');
      addAnchor(yodaGroup, 1000, 200, 'bottomRight');
      addAnchor(yodaGroup, 0, 200, 'bottomLeft');

      var imageObj3 = new Image();
      imageObj3.onload = function() {
        backgroundImg.image(imageObj3);
        layer.draw();
      };
      imageObj3.crossOrigin = 'Anonymous';
      imageObj3.src = '{{background_url}}';

      var imageObj1 = new Image();
      imageObj1.onload = function() {
        darthVaderImg.image(imageObj1);
        layer.draw();
      };
      imageObj1.crossOrigin = 'Anonymous';
      imageObj1.src = '{{icon_url}}';

      var imageObj2 = new Image();
      imageObj2.onload = function() {
        yodaImg.image(imageObj2);
        layer.draw();
      };
      imageObj2.crossOrigin = 'Anonymous';
      imageObj2.src = '{{altitude_url}}';

      function addText() {
        var simpleText = new Konva.Text({
          x: stage.width() / 2,
          y: 40,
          text: 'Simple Text',
          fontSize: 40,
          fontFamily: 'Arial',
          fill: 'white'
        });
        layer.add(simpleText);
        stage.add(layer);
      }

      function downloadURI(uri, name) {
        var link = document.createElement('a');
        link.download = name;
        link.href = uri;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        delete link;
      }

      function hideAnchors() {
        this.find('Circle').hide();
        layer.draw();
      }

      document.getElementById('save').addEventListener(
        'click',
        function() {
          yodaGroup.find('Circle').hide();
          darthVaderGroup.find('Circle').hide();
          var dataURL = stage.toDataURL();
          console.log(dataURL);
          downloadURI(dataURL, 'mappa_image.png');
        },
        false
      );

      document.getElementById('data').addEventListener(
        'click',
        function() {
          console.log('adding data');
          addText();
        },
        false
      );

    </script>
  </body>
</div>

{{activity_id}}
{{icon_url}}
{{name}}
{{altitude_url}}
{{max_speed}}
{{avg_speed}}
{{max_power}}
{{avg_power}}
{{max_heartrate}}
{{avg_heartrate}}
{{duration}}
{{distance}}

{% endblock %}