{% extends "base.html" %}

{% block content %}
<div class="text-center">
    <h2>Mappa</h2>

    {% if current_user.is_anonymous %}

    <p>Please login to use the app</p>
    <a href="{{ url_for('login') }}">login</a>

    {% else %}

    {% endif %}

    <p>Here,you can create a custom image with your activity data</p>
    
    <form id="upload_form" action="/updateuser" method="POST" enctype="multipart/form-data">
      <label for="file">Choose file</label>
      <input type="file" id="fileinput" />
      <img id="source_image">
    </form>

</div>
<div id="buttons">
  <button id="save">
    Save as image
  </button>
  <button id="name">
    Name
  </button>
  <button id="distance">
      Distance
  </button>
  <button id="duration">
      Duration
  </button>
  <button id="max_speed">
    Max Speed
  </button>
  <button id="avg_speed">
    Average Speed
  </button>
</div>


<div class="w-100 p-3" role="presentation" style="position: relative; user-select: none; width: 1000; height: 1000;">
  <canvas class='img-responsive' width="1000" height="1000" style="padding: 0px; margin: 0px; border: 0px; background: 'black'; position: absolute; top: 0px; left: 0px; width: 1000; height: 1000; display: block;">
  </canvas>


  <body>
    <div id="container"></div>
    <script>

    function readFile(evt) {
	    var file = evt.target.files[0];
	    var reader = new FileReader();
	    output_format = "jpg";
	    reader.onload = function(event) {
	        var i = document.getElementById("source_image");
	            i.src = event.target.result;
	            i.onload = function(){
	                image_width=$(i).width(),
	                image_height=$(i).height();

	                if(image_width > image_height){
	                    i.style.width="320px";
	                }else{
	                    i.style.height="300px";
	                }
	                i.style.display = "block";
	                console.log("Image loaded");
	            }
	    };

	    console.log("Filename:" + file.name);
	    console.log("Filesize:" + (parseInt(file.size) / 1024) + " Kb");
      console.log("Type is:" + file.type);
      var upload_url = reader.readAsDataURL(file);
      // reader.readAsDataURL(file);
      console.log(upload_url)

	    return false;
	}

      var topics = [];
      var topics_clean = [];

      var width = window.innerWidth;
      var height = window.innerHeight;

      function update(activeAnchor) {
        var group = activeAnchor.getParent();

        var topLeft = group.get('.topLeft')[0];
        var topRight = group.get('.topRight')[0];
        var bottomRight = group.get('.bottomRight')[0];
        var bottomLeft = group.get('.bottomLeft')[0];
        var image = group.get('Image')[0];

        var anchorX = activeAnchor.getX();
        var anchorY = activeAnchor.getY();

        // update anchor positions
        switch (activeAnchor.getName()) {
          case 'topLeft':
            topRight.y(anchorY);
            bottomLeft.x(anchorX);
            break;
          case 'topRight':
            topLeft.y(anchorY);
            bottomRight.x(anchorX);
            break;
          case 'bottomRight':
            bottomLeft.y(anchorY);
            topRight.x(anchorX);
            break;
          case 'bottomLeft':
            bottomRight.y(anchorY);
            topLeft.x(anchorX);
            break;
        }

        image.position(topLeft.position());

        var width = topRight.getX() - topLeft.getX();
        var height = bottomLeft.getY() - topLeft.getY();
        if (width && height) {
          image.width(width);
          image.height(height);
        }
      }

      function addAnchor(group, x, y, name) {
        var stage = group.getStage();
        var layer = group.getLayer();

        var anchor = new Konva.Circle({
          x: x,
          y: y,
          stroke: '#666',
          fill: '#ddd',
          strokeWidth: 2,
          radius: 8,
          name: name,
          draggable: true,
          dragOnTop: false
        });

        anchor.on('dragmove', function() {
          update(this);
          layer.draw();
        });
        anchor.on('mousedown touchstart', function() {
          group.draggable(false);
          this.moveToTop();
        });
        anchor.on('dragend', function() {
          group.draggable(true);
          layer.draw();
        });
        // add hover styling
        anchor.on('mouseover', function() {
          var layer = this.getLayer();
          document.body.style.cursor = 'pointer';
          this.strokeWidth(4);
          layer.draw();
        });
        anchor.on('mouseout', function() {
          var layer = this.getLayer();
          document.body.style.cursor = 'default';
          this.strokeWidth(2);
          layer.draw();
        });

        group.add(anchor);
      }

      var stage = new Konva.Stage({
        container: 'container',
        width: width,
        height: height
      });

      var layer = new Konva.Layer();
      stage.add(layer);

      // darth vader - route
      var darthVaderImg = new Konva.Image({
        width: 400,
        height: 400
      });

      // yoda - elevation
      var yodaImg = new Konva.Image({
        width: 1000,
        height: 200
      });

      // background
      var backgroundImg = new Konva.Image({
        width: 1000,
        height: 1000
      });

      var backgroundGroup = new Konva.Group({
        x: 0,
        y: 0
      });
      layer.add(backgroundGroup);
      backgroundGroup.add(backgroundImg);

      var darthVaderGroup = new Konva.Group({
        x: 50,
        y: 550,
        draggable: true
      });
      layer.add(darthVaderGroup);
      darthVaderGroup.add(darthVaderImg);
      addAnchor(darthVaderGroup, 0, 0, 'topLeft');
      addAnchor(darthVaderGroup, 450, 0, 'topRight');
      addAnchor(darthVaderGroup, 450, 450, 'bottomRight');
      addAnchor(darthVaderGroup, 0, 450, 'bottomLeft');

      var yodaGroup = new Konva.Group({
        x: 0,
        y: 800,
        draggable: true
      });
      layer.add(yodaGroup);
      yodaGroup.add(yodaImg);
      addAnchor(yodaGroup, 0, 0, 'topLeft');
      addAnchor(yodaGroup, 1000, 0, 'topRight');
      addAnchor(yodaGroup, 1000, 200, 'bottomRight');
      addAnchor(yodaGroup, 0, 200, 'bottomLeft');
      
      // var imageObj3 = new Image();
      // imageObj3.onload = function() {
      //   backgroundImg.image(imageObj3);
      //   layer.draw();
      // };

      document.getElementById('fileinput').addEventListener(
        'change',
        function() {
          console.log("File Input Starting...");
          var reader = new FileReader();
          reader.onload = function(event) {
            console.log("Reader Starting...");
            var dataUri = event.target.result
              // context = document.getElementById("mycanvas").getContext("2d"),
            var imageObj3 = new Image();
 
              // wait until the image has been fully processed
              imageObj3.onload = function() {
                // context.drawImage(img, 100, 100);
                backgroundImg.image(imageObj3);
                layer.draw();
            };
            imageObj3.src = dataUri;
            };
        },
        false
      );

      // var reader = new FileReader();
      // reader.onload = function(event) {
      //     console.log("hello!!!")
      //     document.getElementById('fileinput').addEventListener(
      //     'change',
      //     function() {
      //     console.log("hello!!!");
      //   },
      //     false
      //     );
      //     var dataUri = event.target.result;
      //         // context = document.getElementById("mycanvas").getContext("2d"),
      //     var backround_img = new Image();
      
      //     // wait until the image has been fully processed
      //     backround_img.onload = function() {
      //         context.drawImage(backround_img, 1000, 1000);
      //     };
      //     backround_img.src = dataUri;
      // };

      reader.onerror = function(event) {
          console.error("File could not be read! Code " + event.target.error.code);
      };

      reader.readAsDataURL(file);
      
      imageObj3.crossOrigin = 'Anonymous';
      // imageObj3.src = {{background_url}};

      var imageObj1 = new Image();
      imageObj1.onload = function() {
        darthVaderImg.image(imageObj1);
        layer.draw();
      };
      imageObj1.crossOrigin = 'Anonymous';
      imageObj1.src = '{{icon_url}}';

      var imageObj2 = new Image();
      imageObj2.onload = function() {
        yodaImg.image(imageObj2);
        layer.draw();
      };
      imageObj2.crossOrigin = 'Anonymous';
      imageObj2.src = '{{altitude_url}}';

      var text_layer = new Konva.Layer();

      function addTextOld() {
        text_layer.destroy();
        
        for (i = 0, len = topics.length, text = ""; i < len; i++) {
          var topic = topics[i];
          var simpleText = new Konva.Text({
            x: stage.width() / 2,
            y: 40 + i*50,
            text: topics_clean[i],
            fontSize: 40,
            fontFamily: 'Arial',
            fill: 'white',
          });
          text_layer.add(simpleText);
          textGroup.add(text_layer);
        }
        stage.add(text_layer);
      }

      function addText() {
        text_layer.destroy();
          var simpleText = new Konva.Text({
            x: stage.width() / 2,
            y: 40,
            draggable: true,
            text: topics_clean.join().replace(",", "").replace(",", "").replace(",", "").replace(",", "").replace(",", "").replace(",", ""),
            fontSize: 40,
            fontFamily: 'Arial',
            fill: 'white',
          });
          text_layer.add(simpleText);
          stage.add(text_layer);
        }

      function downloadURI(uri, name) {
        var link = document.createElement('a');
        link.download = name;
        link.href = uri;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        delete link;
      }

      function hideAnchors() {
        this.find('Circle').hide();
        layer.draw();
      }

      document.getElementById('save').addEventListener(
        'click',
        function() {
          yodaGroup.find('Circle').hide();
          darthVaderGroup.find('Circle').hide();
          var dataURL = stage.toDataURL();
          console.log(dataURL);
          downloadURI(dataURL, 'mappa_image.png');
        },
        false
      );

      document.getElementById('name').addEventListener(
        'click',
        function() {
          var index = topics.indexOf('name');
          if (index > -1) {
            // remove from the topics array
            topics.splice(index, 1);
            topics_clean.splice(index, 1);
          }
          else {
            // add to the topics array
            topics.push("name")
            topics_clean.push('{{name}}\n')
          }
          console.log('adding data');
          console.log(topics);
          console.log(topics_clean);
          addText();
        },
        false
      );

      document.getElementById('max_speed').addEventListener(
        'click',
        function() {
          var index = topics.indexOf('max_speed');
          if (index > -1) {
            // remove from the topics array
            topics.splice(index, 1);
            topics_clean.splice(index, 1);
          }
          else {
            // add to the topics array
            topics.push("max_speed")
            topics_clean.push('{{max_speed}}\n')
          }
          console.log('adding data');
          console.log(topics);
          addText();
        },
        false
      );

      document.getElementById('avg_speed').addEventListener(
        'click',
        function() {
          var index = topics.indexOf('avg_speed');
          if (index > -1) {
            // remove from the topics array
            topics.splice(index, 1);
            topics_clean.splice(index, 1);
          }
          else {
            // add to the topics array
            topics.push("avg_speed")
            topics_clean.push('{{avg_speed}}\n')
          }
          console.log('adding data');
          console.log(topics);
          addText();
        },
        false
      );

      document.getElementById('distance').addEventListener(
        'click',
        function() {
          var index = topics.indexOf('distance');
          if (index > -1) {
            // remove from the topics array
            topics.splice(index, 1);
            topics_clean.splice(index, 1);
          }
          else {
            // add to the topics array
            topics.push("distance")
            topics_clean.push('{{distance}}\n')
          }
          console.log('adding data');
          console.log(topics);
          addText();
        },
        false
      );

      document.getElementById('duration').addEventListener(
        'click',
        function() {
          var index = topics.indexOf('duration');
          if (index > -1) {
            // remove from the topics array
            topics.splice(index, 1);
            topics_clean.splice(index, 1);
          }
          else {
            // add to the topics array
            topics.push("duration")
            topics_clean.push('{{duration}}\n')
          }
          console.log('adding data');
          console.log(topics);
          addText();
        },
        false
      );

    </script>
  </body>
</div>

{{name}}
{{icon_url}}
{{activity_id}}
{{altitude_url}}
{{max_speed}}
{{avg_speed}}
{{max_power}}
{{avg_power}}
{{max_heartrate}}
{{avg_heartrate}}
{{duration}}
{{distance}}

{% endblock %}