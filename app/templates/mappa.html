{% extends "base.html" %}

{% block content %}
<div class="text-center">
    <!-- <h2>Mappa</h2> -->

    {% if current_user.is_anonymous %}

    <p>Please login to use the app</p>
    <a href="{{ url_for('login') }}">login</a>

    {% else %}

    {% endif %}
    
    <form id="upload_form" action="/updateuser" method="POST" enctype="multipart/form-data">
      <input type="file" id="fileinput" class="btn btn-primary btn-sm"/>
      <img id="source_image" style="height: 0px">
    </form>


<div id="buttons" >
  <p></p>
  <button id="name" class="btn btn-secondary btn-sm">
    Name
  </button>
  <button id="distance" class="btn btn-secondary btn-sm">
      Distance
  </button>
  <button id="duration" class="btn btn-secondary btn-sm">
      Duration
  </button>
  <button id="max_speed" class="btn btn-secondary btn-sm">
    Max Speed
  </button>
  <button id="avg_speed" class="btn btn-secondary btn-sm">
    Average Speed
  </button>
  <p></p>
  <p>
    <button id="rotate_background" class="btn btn-secondary btn-sm">
      Rotate Background
    </button>
    <button id="save" class="btn btn-primary btn-sm">
      Save as image
    </button>
  </p>
</div>
</div>

<div id="stage-parent">
<div id="container" class="w-100 p-3" role="presentation" style="position: relative; user-select: none; width: 1000; height: 1000;">
  <canvas class='img-responsive' width="100%" style="padding: 0px; margin: 0px; border: 0px; background: 'black'; position: absolute; top: 0px; left: 0px; width: 1000; height: 1000; display: block;">
  </canvas>


  <body>
    <div id="container"></div>
    <script>

      var topics = [];
      var topics_clean = [];

      var stageWidth = 1000;
      var stageHeight = 1000;

      var width = window.innerWidth;
      var height = window.innerHeight;

      function update(activeAnchor) {
        var group = activeAnchor.getParent();
        // replaced get with find
        var topLeft = group.find('.topLeft')[0];
        var topRight = group.find('.topRight')[0];
        var bottomRight = group.find('.bottomRight')[0];
        var bottomLeft = group.find('.bottomLeft')[0];
        var image = group.find('Image')[0];

        var anchorX = activeAnchor.getX();
        var anchorY = activeAnchor.getY();

        // update anchor positions
        switch (activeAnchor.getName()) {
          case 'topLeft':
            topRight.y(anchorY);
            bottomLeft.x(anchorX);
            break;
          case 'topRight':
            topLeft.y(anchorY);
            bottomRight.x(anchorX);
            break;
          case 'bottomRight':
            bottomLeft.y(anchorY);
            topRight.x(anchorX);
            break;
          case 'bottomLeft':
            bottomRight.y(anchorY);
            topLeft.x(anchorX);
            break;
        }

        image.position(topLeft.position());

        var width = topRight.getX() - topLeft.getX();
        var height = bottomLeft.getY() - topLeft.getY();
        if (width && height) {
          image.width(width);
          image.height(height);
        }
      }

      function addAnchor(group, x, y, name) {
        var stage = group.getStage();
        var layer = group.getLayer();

        var anchor = new Konva.Circle({
          x: x,
          y: y,
          stroke: '#666',
          fill: '#ddd',
          strokeWidth: 2,
          radius: 15,
          name: name,
          draggable: true,
          dragOnTop: false
        });

        anchor.on('dragmove', function() {
          update(this);
          layer.draw();
        });
        anchor.on('mousedown touchstart', function() {
          group.draggable(false);
          this.moveToTop();
        });
        anchor.on('dragend', function() {
          group.draggable(true);
          layer.draw();
        });
        // add hover styling
        anchor.on('mouseover', function() {
          var layer = this.getLayer();
          document.body.style.cursor = 'pointer';
          this.strokeWidth(4);
          layer.draw();
        });
        anchor.on('mouseout', function() {
          var layer = this.getLayer();
          document.body.style.cursor = 'default';
          this.strokeWidth(2);
          layer.draw();
        });

        group.add(anchor);
      }

      var stage = new Konva.Stage({
        container: 'container',
        width: stageWidth,
        height: stageHeight
      });

      function fitStageIntoParentContainer() {
        var container = document.querySelector('#stage-parent');

        // now we need to fit stage into parent
        var containerWidth = container.offsetWidth;
        // to do this we need to scale the stage
        var scale = containerWidth / stageWidth;

        stage.width(stageWidth * scale * 0.95);
        stage.height(stageHeight * scale * 0.95);
        stage.scale({ x: scale, y: scale });
        stage.draw();
      }

      fitStageIntoParentContainer();
      // adapt the stage on any window resize
      window.addEventListener('resize', fitStageIntoParentContainer);

      var layer = new Konva.Layer();
      stage.add(layer);

      // yoda - elevation
      var elevationImg = new Konva.Image({
        width: 1100,
        height: 300
      });

      // darth vader - route
      var routeImg = new Konva.Image({
        width: 400,
        height: 400
      });

      // init_background
      var initBackgroundImg = new Konva.Image({
        width: 950,
        height: 950
      });

      var initBackgroundGroup = new Konva.Group({
        x: 0,
        y: 0,
      });
      layer.add(initBackgroundGroup);
      initBackgroundGroup.add(initBackgroundImg);

      var imageObj0 = new Image();
      imageObj0.onload = function() {
        initBackgroundImg.image(imageObj0);
        layer.draw();
      };
      imageObj0.crossOrigin = 'Anonymous';
      imageObj0.src = 'https://i.ibb.co/TqrrvJJ/mappa-init-back.png';

      // background
      var backgroundImg = new Konva.Image({
        width: 950,
        height: 950
      });

      var backgroundGroup = new Konva.Group({
        x: 0,
        y: 0,
        name: 'background_group'
      });
      layer.add(backgroundGroup);
      backgroundGroup.add(backgroundImg);



      // 0, 800
      var elevationGroup = new Konva.Group({
        x: 0,
        y: 705,
        offsetX:85,
        draggable: true
      });
      layer.add(elevationGroup);
      elevationGroup.add(elevationImg);
      // addAnchor(elevationGroup, 0, 0, 'topLeft');
      // addAnchor(elevationGroup, 1000, 0, 'topRight');
      // addAnchor(elevationGroup, 1000, 200, 'bottomRight');
      // addAnchor(elevationGroup, 0, 200, 'bottomLeft');

      var routeGroup = new Konva.Group({
        x: 50,
        y: 450,
        draggable: true
      });
      layer.add(routeGroup);
      routeGroup.add(routeImg);
      addAnchor(routeGroup, 0, 0, 'topLeft');
      addAnchor(routeGroup, 450, 0, 'topRight');
      addAnchor(routeGroup, 450, 450, 'bottomRight');
      addAnchor(routeGroup, 0, 450, 'bottomLeft');

      var imageObj2 = new Image();
      imageObj2.onload = function() {
        elevationImg.image(imageObj2);
        layer.draw();
      };
      imageObj2.crossOrigin = 'Anonymous';
      imageObj2.src = '{{altitude_url}}';

      var imageObj1 = new Image();
      imageObj1.onload = function() {
        routeImg.image(imageObj1);
        layer.draw();
      };
      imageObj1.crossOrigin = 'Anonymous';
      imageObj1.src = '{{icon_url}}';

      document.getElementById('fileinput').addEventListener(
        'change',
        function(evt) {
          var file = evt.target.files[0];
          var reader = new FileReader();
          output_format = "jpg";
          reader.onload = function(event) {
              var i = document.getElementById("source_image");
              i.src = event.target.result;
              i.onload = function(){
                var imageObj3 = new Image();
                imageObj3.onload = function() {
                backgroundImg.image(imageObj3);
                var w = imageObj3.width
                var h = imageObj3.height
                var offset_x = 0
                var offset_y = 0
                
                if (w > h) {
                  var offset_x = (w-h)/2;
                  var w = h;
                  console.log('w > h');
                } else {
                  var offset_y = (h-w)/2;
                  var h = w;
                  console.log('w < h');
                }

                var crop = backgroundImg.crop();
                backgroundImg.crop({
                  x:offset_x,
                  y:offset_y,
                  width: w,
                  height: h
                });
                layer.draw();
                };
              imageObj3.src = i.src;
              return imageObj3
              },
              false
              };

          console.log("Filename:" + file.name);
          console.log("Filesize:" + (parseInt(file.size) / 1024) + " Kb");
          console.log("Type:" + file.type);
          reader.readAsDataURL(file);

          return false;
        },
        false
      );

      document.getElementById('rotate_background').addEventListener(
        'click',
        function() {
          console.log(backgroundImg)
          backgroundImg.rotate(90);
          backgroundImg.offsetX(475);
          backgroundImg.offsetY(475);
          backgroundImg.setX(475);
          backgroundImg.setY(475);
          stage.draw();
          console.log('loaded');
        },
        false
      );

      var text_layer = new Konva.Layer();

      function addText() {
        text_layer.destroy();
          var simpleLabel = new Konva.Label({
            x: 80,
            y: 80,
            draggable: true,
          });

          simpleLabel.add(
            new Konva.Tag({
              fill: '#e8f4f8',
              stroke: '#286e84',
              opacity: 0.45
            })
          );

          var topics_text = topics_clean.join().replace(",", "").replace(",", "").replace(",", "").replace(",", "").replace(",", "").replace(",", "").replace(",", "");
          var topics_text = topics_text.substring(0, topics_text.length - 1);
          simpleLabel.add(
            new Konva.Text({
            text: topics_text,
            fontSize: 40,
            fontFamily: 'sans-serif',
            fill: 'white',
            padding: 10,
            opacity: 1,
          })
          );

          text_layer.add(simpleLabel);
          stage.add(text_layer);
        }

      function downloadURI(uri, name) {
        var link = document.createElement('a');
        link.download = name;
        link.href = uri;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        delete link;
      }

      function hideAnchors() {
        this.find('Circle').hide();
        layer.draw();
      }

      document.getElementById('save').addEventListener(
        'click',
        function() {
          elevationGroup.find('Circle').hide();
          routeGroup.find('Circle').hide();
          var dataURL = stage.toDataURL({ pixelRatio: 6 });
          console.log(dataURL);
          downloadURI(dataURL, 'mappa_image.png');
        },
        false
      );

      document.getElementById('name').addEventListener(
        'click',
        function() {
          var index = topics.indexOf('name');
          if (index > -1) {
            // remove from the topics array
            topics.splice(index, 1);
            topics_clean.splice(index, 1);
          }
          else {
            // add to the topics array
            topics.push("name")
            topics_clean.push('{{name}}\n')
          }
          console.log('adding data');
          console.log(topics);
          console.log(topics_clean);
          addText();
        },
        false
      );

      document.getElementById('max_speed').addEventListener(
        'click',
        function() {
          var index = topics.indexOf('max_speed');
          if (index > -1) {
            // remove from the topics array
            topics.splice(index, 1);
            topics_clean.splice(index, 1);
          }
          else {
            // add to the topics array
            topics.push("max_speed")
            topics_clean.push('{{max_speed}}\n')
          }
          console.log('adding data');
          console.log(topics);
          addText();
        },
        false
      );

      document.getElementById('avg_speed').addEventListener(
        'click',
        function() {
          var index = topics.indexOf('avg_speed');
          if (index > -1) {
            // remove from the topics array
            topics.splice(index, 1);
            topics_clean.splice(index, 1);
          }
          else {
            // add to the topics array
            topics.push("avg_speed")
            topics_clean.push('{{avg_speed}}\n')
          }
          console.log('adding data');
          console.log(topics);
          addText();
        },
        false
      );

      document.getElementById('distance').addEventListener(
        'click',
        function() {
          var index = topics.indexOf('distance');
          if (index > -1) {
            // remove from the topics array
            topics.splice(index, 1);
            topics_clean.splice(index, 1);
          }
          else {
            // add to the topics array
            topics.push("distance")
            topics_clean.push('{{distance}}\n')
          }
          console.log('adding data');
          console.log(topics);
          addText();
        },
        false
      );

      document.getElementById('duration').addEventListener(
        'click',
        function() {
          var index = topics.indexOf('duration');
          if (index > -1) {
            // remove from the topics array
            topics.splice(index, 1);
            topics_clean.splice(index, 1);
          }
          else {
            // add to the topics array
            topics.push("duration")
            topics_clean.push('{{duration}}\n')
          }
          console.log('adding data');
          console.log(topics);
          addText();
        },
        false
      );

    </script>
  </body>
</div>
</div>
</div>

<p>Here you can create a custom image with your activity data. Choose a photo to upload and click the info buttons to add data to your image!</p>

{{name}}
{{icon_url}}
{{activity_id}}
{{altitude_url}}
{{max_speed}}
{{avg_speed}}
{{max_power}}
{{avg_power}}
{{max_heartrate}}
{{avg_heartrate}}
{{duration}}
{{distance}}

{% endblock %}

<!-- 
// function readFile(evt) {
  //   var file = evt.target.files[0];
  //   var reader = new FileReader();
  //   output_format = "jpg";
  //   reader.onload = function(event) {
  //       var i = document.getElementById("source_image");
  //           i.src = event.target.result;
  //           i.onload = function(){
  //               image_width=$(i).width(),
  //               image_height=$(i).height();

  //               if(image_width > image_height){
  //                   i.style.width="320px";
  //               }else{
  //                   i.style.height="300px";
  //               }
  //               i.style.display = "block";
  //               console.log("Image loaded");
  //               console.log(i.src);
  //           }
  //     };

  //   console.log("Filename:" + file.name);
  //   console.log("Filesize:" + (parseInt(file.size) / 1024) + " Kb");
  //   console.log("Type:" + file.type);
  //   reader.readAsDataURL(file);

  //   return false;
  //   } -->

  <!-- document.getElementById('fileinput').addEventListener(
    'change',
    function(evt) {
      var file = evt.target.files[0];
      var reader = new FileReader();
      output_format = "jpg";
      reader.onload = function(event) {
          var i = document.getElementById("source_image");
              i.src = event.target.result;
              i.onload = function(){
                  // image_width=$(i).width(),
                  // image_height=$(i).height();

                  // if(image_width > image_height){
                  //     i.style.width="0";
                  // }else{
                  //     i.style.height="0";
                  // }
                  // i.style.display = "block";
                  // console.log("Image loaded");
                  // console.log(i.src);

                  var imageObj3 = new Image();
                  // var crop = imageObj3.crop();
                  imageObj3.onload = function() {
                    backgroundImg.image(imageObj3);
                    layer.draw();
                  };
                  // imageObj3.crossOrigin = 'Anonymous';
                  imageObj3.src = i.src;
                  // imageObj3.crop({
                  //     x: 0,
                  //     y: 0,
                  //     width: 200,
                  //     height: 200
                  //   });
                  
              }
        };

      console.log("Filename:" + file.name);
      console.log("Filesize:" + (parseInt(file.size) / 1024) + " Kb");
      console.log("Type:" + file.type);
      reader.readAsDataURL(file);

      return false;
    },
    false
  ); -->